<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GeoDash - Opravená Verzia</title>
    <style>
        :root { --primary: #00f2ff; }
        * { box-sizing: border-box; touch-action: none; }
        body { margin: 0; overflow: hidden; font-family: 'Arial Black', sans-serif; background: #000; display: flex; justify-content: center; align-items: center; height: 100vh; }
        #game-container { position: relative; width: 100%; max-width: 800px; aspect-ratio: 16 / 9; background: #050505; border: 2px solid #333; }
        canvas { width: 100%; height: 100%; display: block; }
        #ui-layer { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.85); z-index: 10; }
        .hidden { display: none !important; }
        h1 { font-size: 50px; color: var(--primary); text-shadow: 0 0 15px var(--primary); margin: 0 0 15px 0; }
        .panel { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; border: 1px solid var(--primary); text-align: center; width: 320px; }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        button { padding: 12px; cursor: pointer; background: var(--primary); border: none; color: black; border-radius: 5px; font-weight: bold; text-transform: uppercase; font-size: 13px; }
        #progress-bar { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); width: 70%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; display: none; }
        #progress-fill { width: 0%; height: 100%; background: var(--primary); transition: 0.1s; }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="progress-bar"><div id="progress-fill"></div></div>
        <div id="ui-layer">
            <h1>GEODASH</h1>
            <div class="panel">
                <label style="font-size: 12px; display: block; margin-bottom: 5px;">FARBA KOCKY:</label>
                <input type="color" id="pColor" value="#00f2ff" style="width:100%; height:30px; border:none; background:none; cursor:pointer;" onchange="updatePrimaryColor()">
                <div class="btn-grid">
                    <button onclick="startGame('level1')">Level 1</button>
                    <button onclick="startGame('level2')">Level 2</button>
                    <button onclick="startGame('level3')">Level 3</button>
                    <button onclick="startGame('endless')" style="background:#ffcc00">Endless</button>
                </div>
            </div>
        </div>
        <canvas id="gameCanvas"></canvas>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const uiLayer = document.getElementById('ui-layer');
        const progressFill = document.getElementById('progress-fill');
        const progressBar = document.getElementById('progress-bar');

        canvas.width = 800; canvas.height = 450;

        const playlist = {
            level1: new Audio('https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3'),
            level2: new Audio('https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3'),
            level3: new Audio('https://www.soundhelix.com/examples/mp3/SoundHelix-Song-10.mp3'),
            endless: new Audio('https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3')
        };
        let currentAudio = null;

        let gameState = 'menu';
        let currentLevel = null;
        let distance = 0;
        let speed = 7.5;
        let isHoldingJump = false;
        let pColor = "#00f2ff";
        const groundY = 350;

        let player = { x: 120, y: groundY - 40, size: 40, vy: 0, rotation: 0, isJumping: false };
        let obstacles = [];

        // Typy: S = Spike, D = Double Spike, B = Block, C = Ceiling
        const levelData = {
            level1: {
                end: 8000,
                map: [
                    {x: 800, t:'S'}, {x: 1400, t:'B'}, {x: 2000, t:'D'}, {x: 2600, t:'C'}, {x: 3200, t:'S'},
                    {x: 3800, t:'B'}, {x: 4400, t:'D'}, {x: 5000, t:'C'}, {x: 5600, t:'S'}, {x: 6200, t:'B'}, {x: 7000, t:'D'}
                ]
            },
            level2: {
                end: 12000,
                map: [
                    {x: 700, t:'D'}, {x: 1100, t:'C'}, {x: 1600, t:'B'}, {x: 2100, t:'D'}, {x: 2600, t:'S'},
                    {x: 3100, t:'C'}, {x: 3600, t:'B'}, {x: 4100, t:'D'}, {x: 4700, t:'C'}, {x: 5300, t:'S'},
                    {x: 5900, t:'B'}, {x: 6500, t:'D'}, {x: 7200, t:'C'}, {x: 8000, t:'S'}, {x: 8800, t:'B'},
                    {x: 9600, t:'D'}, {x: 10500, t:'S'}, {x: 11200, t:'C'}
                ]
            },
            level3: {
                end: 16000,
                map: [
                    {x: 600, t:'C'}, {x: 900, t:'D'}, {x: 1300, t:'S'}, {x: 1700, t:'B'}, {x: 2100, t:'C'},
                    {x: 2500, t:'D'}, {x: 3000, t:'S'}, {x: 3500, t:'B'}, {x: 4000, t:'C'}, {x: 4500, t:'D'},
                    {x: 5000, t:'S'}, {x: 5500, t:'B'}, {x: 6100, t:'C'}, {x: 6700, t:'D'}, {x: 7300, t:'S'},
                    {x: 7900, t:'B'}, {x: 8500, t:'C'}, {x: 9200, t:'D'}, {x: 10000, t:'S'}, {x: 10800, t:'B'},
                    {x: 11500, t:'C'}, {x: 12300, t:'D'}, {x: 13200, t:'S'}, {x: 14000, t:'B'}, {x: 15000, t:'D'}
                ]
            }
        };

        function updatePrimaryColor() {
            pColor = document.getElementById('pColor').value;
            document.documentElement.style.setProperty('--primary', pColor);
        }

        function startGame(mode) {
            if(currentAudio) { currentAudio.pause(); currentAudio.currentTime = 0; }
            updatePrimaryColor();
            gameState = 'playing'; currentLevel = mode;
            uiLayer.classList.add('hidden'); progressBar.style.display = 'block';
            currentAudio = playlist[mode] || playlist.endless;
            currentAudio.play().catch(() => {});
            resetGame();
        }

        function resetGame() {
            distance = 0; player.y = groundY - player.size; player.vy = 0; player.rotation = 0;
            obstacles = (currentLevel === 'endless') ? [] : JSON.parse(JSON.stringify(levelData[currentLevel].map));
        }

        function update() {
            if(gameState !== 'playing') return;
            distance += speed;
            if(isHoldingJump && !player.isJumping) { player.vy = -13; player.isJumping = true; }
            player.vy += 0.8; player.y += player.vy;

            if(player.y > groundY - player.size) {
                player.y = groundY - player.size; player.vy = 0; player.isJumping = false;
                player.rotation = Math.round(player.rotation / 90) * 90;
            }

            obstacles.forEach(obs => {
                let screenX = obs.x - distance + 300;
                if(obs.t === 'S' || obs.t === 'D') {
                    let w = (obs.t === 'D' ? 80 : 40);
                    if(player.x + player.size - 12 > screenX && player.x + 12 < screenX + w && player.y + player.size > groundY - 38) gameOver();
                } else if(obs.t === 'B') {
                    if(player.x + player.size > screenX && player.x < screenX + 40) {
                        if(player.y + player.size >= groundY - 40 && player.y + player.size <= groundY - 20 && player.vy >= 0) {
                            player.y = groundY - 40 - player.size; player.vy = 0; player.isJumping = false;
                        } else if(player.y + player.size > groundY - 35) gameOver();
                    }
                } else if(obs.t === 'C') {
                    if(player.x + player.size > screenX && player.x < screenX + 100 && player.y < 240) gameOver();
                }
            });

            if(player.isJumping) player.rotation += 6;

            if(currentLevel !== 'endless') {
                let p = (distance / levelData[currentLevel].end) * 100;
                progressFill.style.width = Math.min(p, 100) + "%";
                if(distance > levelData[currentLevel].end) victory();
            } else if(Math.random() < 0.01) {
                obstacles.push({x: distance + 800, t: ['S','D','B','C'][Math.floor(Math.random()*4)]});
            }
        }

        function gameOver() {
            gameState = 'menu'; currentAudio.pause();
            uiLayer.classList.remove('hidden'); alert("CRASH!"); resetGame();
        }

        function victory() {
            gameState = 'menu'; currentAudio.pause();
            alert("LEVEL COMPLETE!"); uiLayer.classList.remove('hidden');
        }

        function draw() {
            ctx.fillStyle = "#0a0a15"; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "#111"; ctx.fillRect(0, groundY, canvas.width, canvas.height - groundY);
            ctx.strokeStyle = pColor; ctx.lineWidth = 2; ctx.strokeRect(-5, groundY, canvas.width + 10, 2);

            if(gameState === 'playing') {
                ctx.save();
                ctx.translate(player.x + player.size/2, player.y + player.size/2);
                ctx.rotate(player.rotation * Math.PI / 180);
                ctx.fillStyle = pColor; ctx.shadowBlur = 10; ctx.shadowColor = pColor;
                ctx.fillRect(-player.size/2, -player.size/2, player.size, player.size);
                ctx.strokeStyle = "white"; ctx.strokeRect(-20+4, -20+4, 32, 32);
                ctx.restore();

                obstacles.forEach(obs => {
                    let sx = obs.x - distance + 300;
                    if(obs.t === 'S' || obs.t === 'D') {
                        ctx.fillStyle = "#333"; ctx.strokeStyle = "#ff4444";
                        for(let i=0; i<(obs.t==='D'?2:1); i++) {
                            ctx.beginPath(); ctx.moveTo(sx+(i*40), groundY); ctx.lineTo(sx+40+(i*40), groundY); ctx.lineTo(sx+20+(i*40), groundY-40); ctx.closePath(); ctx.fill(); ctx.stroke();
                        }
                    } else if(obs.t === 'B') {
                        ctx.fillStyle = "#444"; ctx.strokeStyle = "white";
                        ctx.fillRect(sx, groundY-40, 40, 40); ctx.strokeRect(sx, groundY-40, 40, 40);
                    } else if(obs.t === 'C') {
                        ctx.fillStyle = "#444"; ctx.strokeStyle = pColor;
                        ctx.fillRect(sx, 130, 100, 60); ctx.strokeRect(sx, 130, 100, 60);
                    }
                });
            }
            requestAnimationFrame(draw); update();
        }

        // --- OVLÁDANIE ---
        const startJump = (e) => { if(e) e.preventDefault(); isHoldingJump = true; };
        const endJump = (e) => { if(e) e.preventDefault(); isHoldingJump = false; };

        // Klávesnica
        window.addEventListener('keydown', (e) => { if(e.code === 'Space' || e.code === 'ArrowUp') startJump(); });
        window.addEventListener('keyup', (e) => { if(e.code === 'Space' || e.code === 'ArrowUp') endJump(); });

        // Myš
        canvas.addEventListener('mousedown', startJump);
        window.addEventListener('mouseup', endJump);

        // Dotyk (Mobil)
        canvas.addEventListener('touchstart', startJump, {passive: false});
        canvas.addEventListener('touchend', endJump, {passive: false});

        draw();
    </script>
</body>
</html>
